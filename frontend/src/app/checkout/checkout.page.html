<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/cart"></ion-back-button>
    </ion-buttons>
    <ion-title>Checkout</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="cartItems$ | async as items">
    <section class="summary">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Resumen de productos</ion-card-title>
      </ion-card-header>
      <ion-card-content>
          <ng-container *ngIf="items.length; else summaryEmpty">
            <div class="summary-item" *ngFor="let item of items">
              <div>
                <strong>{{ item.articulo?.nombre }}</strong>
                <p>
                  {{ item.cantidad }} x {{ item.articulo?.precio_venta | currency:'EUR' }}
                  <span class="offer-label" *ngIf="item.articulo?.oferta">OFERTA</span>
                </p>
              </div>
              <span>{{ (item.cantidad * (item.articulo?.precio_venta || 0)) | currency:'EUR' }}</span>
            </div>
          </ng-container>
        </ion-card-content>
      </ion-card>
    </section>

    <form *ngIf="items.length; else emptyCart" [formGroup]="checkoutForm" class="checkout-form">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos de envío</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Dirección</ion-label>
          <ion-input formControlName="direccion" placeholder="Calle, número, ciudad"></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="checkoutForm.get('direccion')?.touched && checkoutForm.get('direccion')?.invalid">
          La dirección es obligatoria.
        </ion-note>

        <ion-item>
          <ion-label position="stacked">Teléfono</ion-label>
          <ion-input formControlName="telefono" type="tel" placeholder="Número de contacto"></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="checkoutForm.get('telefono')?.touched && checkoutForm.get('telefono')?.invalid">
          El teléfono es obligatorio.
        </ion-note>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Información de pago</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p class="payment-info">
          <ion-icon name="shield-checkmark-outline" color="success"></ion-icon>
          El pago se procesará de forma segura con <strong>Stripe</strong>
        </p>
        <small>Se redireccionará al formulario seguro de pago de Stripe.</small>
      </ion-card-content>
    </ion-card>

      <ion-card *ngIf="totals$ | async as totals">
      <ion-card-header>
        <ion-card-title>Total a pagar</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="total-row">
          <span>Subtotal</span>
          <strong>{{ totals.subtotal | currency:'EUR' }}</strong>
        </div>
        <div class="total-row">
          <span>Impuestos</span>
          <strong>{{ totals.impuesto | currency:'EUR' }}</strong>
        </div>
        <div class="total-row total-row__grand">
          <span>Total</span>
          <strong>{{ totals.total | currency:'EUR' }}</strong>
        </div>
      </ion-card-content>
    </ion-card>

      <ion-button expand="block" color="success" (click)="irAPago()" [disabled]="checkoutForm.invalid || !items.length || isProcessing">
      <ion-spinner *ngIf="isProcessing" name="crescent"></ion-spinner>
      {{ isProcessing ? 'Procesando...' : 'Ir a Pagar con Stripe' }}
    </ion-button>
    </form>
  </ng-container>

  <ng-template #summaryEmpty>
    <p class="summary-empty">Agrega productos al carrito para ver el detalle.</p>
  </ng-template>

  <ng-template #emptyCart>
    <div class="empty-message">
      <ion-icon name="cart"></ion-icon>
      <p>Tu carrito está vacío.</p>
      <ion-button routerLink="/home" color="primary">Volver a la tienda</ion-button>
    </div>
  </ng-template>
</ion-content>
